name: Regression Checks

on:
  pull_request:
  push:
    branches: [ "main" ]

jobs:
  regression:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          command -v shellcheck || (sudo apt-get update && sudo apt-get install -y shellcheck)
          shellcheck --version

      - name: Bash syntax check (key scripts)
        run: |
          set -euo pipefail
          bash -n modules/wp/install-ols-wp-standard.sh
          bash -n hz.sh

      - name: ShellCheck (key scripts)
        run: |
          set -euo pipefail
          shellcheck -x modules/wp/install-ols-wp-standard.sh hz.sh

      - name: Forbidden terms in user-facing output
        run: |
          set -euo pipefail
          shopt -s nullglob globstar

          scripts=(
            hz.sh
            modules/**/*.sh
            lib/**/*.sh
          )

          filtered_scripts=()
          for script in "${scripts[@]}"; do
            case "$script" in
              ./tests/*|tests/*|./.github/*|.github/*|./docs/*|docs/*|./.git/*|.git/*)
                continue
                ;;
            esac
            filtered_scripts+=("$script")
          done

          if [ "${#filtered_scripts[@]}" -eq 0 ]; then
            echo "No user-facing shell scripts detected; skipping forbidden term check."
            exit 0
          fi

          forbidden_re='(echo|printf).*?(oracle|aws|amazon|aliyun|tencent|azure|gcp|google cloud)'
          if matches=$(grep -nEi "$forbidden_re" "${filtered_scripts[@]}" || true); then
            if [ -n "$matches" ]; then
              echo "Forbidden cloud provider references found in user-facing scripts:"
              echo "$matches"
              exit 1
            fi
          fi

          echo "No forbidden cloud provider references detected in user-facing scripts."
