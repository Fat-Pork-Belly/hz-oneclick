name: Auto-merge (bot PRs)

on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]

concurrency:
  group: auto-merge-${{ github.repository }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: write

jobs:
  enable-automerge:
    if: >
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name &&
      (startsWith(github.head_ref, 'codex/') || contains(join(github.event.pull_request.labels.*.name, ','), 'codex'))
    runs-on: ubuntu-latest
    steps:
      - name: Check if auto-merge already enabled
        id: check-auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          enabled=$(gh pr view "$PR_NUMBER" --json autoMergeRequest --jq '.autoMergeRequest != null')
          echo "enabled=$enabled" >> "$GITHUB_OUTPUT"

          if [ "$enabled" = "true" ]; then
            echo "Auto-merge already enabled."
            exit 0
          fi
      - name: Enable auto-merge
        if: steps.check-auto-merge.outputs.enabled != 'true'
        id: enable-automerge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          output=$(gh pr merge "$PR_NUMBER" --squash --auto 2>&1)
          status=$?

          echo "$output"

          if [ $status -ne 0 ]; then
            if echo "$output" | grep -qi "Merge already in progress"; then
              echo "skip_verify=true" >> "$GITHUB_OUTPUT"
              echo "Merge already in progress; exiting successfully."
              exit 0
            fi

            exit $status
          fi

          echo "skip_verify=false" >> "$GITHUB_OUTPUT"
      - name: Verify auto-merge is enabled
        if: steps.check-auto-merge.outputs.enabled != 'true' && steps.enable-automerge.outputs.skip_verify != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"
          query=$(cat <<'EOF'
          query($owner:String!, $repo:String!, $number:Int!) {
            repository(owner: $owner, name: $repo) {
              pullRequest(number: $number) {
                autoMergeRequest {
                  enabledAt
                }
              }
            }
          }
          EOF
          )

          payload=$(jq -n \
            --arg query "$query" \
            --arg owner "$owner" \
            --arg repo "$repo" \
            --argjson number "$PR_NUMBER" \
            '{query: $query, variables: {owner: $owner, repo: $repo, number: $number}}')

          response=$(curl -s \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "$payload" \
            https://api.github.com/graphql)

          enabled_at=$(echo "$response" | jq -r '.data.repository.pullRequest.autoMergeRequest.enabledAt')

          if [ "$enabled_at" = "null" ] || [ -z "$enabled_at" ]; then
            echo "Auto-merge was not enabled. Response:"
            echo "$response"
            exit 1
          fi
